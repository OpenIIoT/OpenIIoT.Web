<!-- Content Header (Page header) -->
<section class="content-header">
  <h1>
    Security
  </h1>
  <ol class="breadcrumb">
    <li><a href="#"><i class="fa fa-home"></i> Home</a></li>
    <li><a href="#">Administration</a></li>
    <li class="active">Security</li>
  </ol>
</section>

<!-- Main content -->
<section class="content container-fluid">
  <!-- users list -->
  <div class="row">
    <div class="col-xs-12">
      <div class="box box-primary">
        <div class="box-header">
          <i class="fa fa-group"></i>

          <h3 class="box-title">Users</h3>
        </div>
        <div class="box-body table-responsive">
          <table id="users" class="table table-hover">
            <tr>
              <th>Username</th>
              <th>Full Name</th>
              <th>Email</th>
              <th>Role</th>
              <th style="width: 10px"></th>
              <th style="width: 10px"></th>
            </tr>
            <!-- rows inserted via javascript -->
          </table>
          <button type="button" style="width: 200; margin-top: 30px" class="pull-right btn btn-primary"><i class="fa fa-plus" aria-hidden="true"/> New User</button>
        </div>
        <!-- /.box-body-->
      </div>
      <!-- /.box -->

    </div>
    <!-- /.col -->

  </div>
  <!-- /users list -->

  <!-- session list -->
  <div class="row">
    <div class="col-xs-12">
      <div class="box">
        <div class="box-header">
          <i class="fa fa-id-card"></i>

          <h3 class="box-title">Active Sessions</h3>
        </div>
        <div class="box-body table-responsive">
          <table id="sessions" class="table table-hover">
            <tr>
              <th>Token</th>
              <th>Username</th>
              <th>Created</th>
              <th>Expires</th>
              <th style="width: 10px"></th>
            </tr>
            <!-- rows inserted via javascript -->
          </table>
        </div>
        <!-- /.box-body-->
      </div>
      <!-- /.box -->

    </div>
    <!-- /.col -->

  </div>
  <!-- /session list -->

  <div class="modal fade" id="token-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="token-title">Session Token for User <strong><span id="token-user"></span></strong></h4>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <input id="token-body" type="text" class="form-control">
            <span class="input-group-btn">
              <button onclick="copyToken()" type="button" class="btn btn-info btn-flat"><i class='fa fa-copy' aria-hidden='true'/></i></button>
            </span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary pull-right" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->

  <div class="modal fade" id="session-modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"><i class="fa fa-trash"></i> End Session</h4>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to end the session with token beginning with <strong><span id="session-token-partial"></span>...</strong> for user <strong><span id="session-user"></span></strong>?</p>
            <input id="session-token" type="hidden"/>
          </div>
          <div class="modal-footer">
            <button onclick="endSession()" type="button" class="btn btn-danger"><i class="fa fa-trash"></i> End Session</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-times"></i> Cancel</button>

            <div id="session-token-alert" style="margin-top: 15px; margin-bottom: 0px; text-align:left; width: 100%" class="alert alert-danger alert-dismissible hidden">
                <button type="button" class="close" onclick="endSessionAlertDismiss()" aria-hidden="true">&times;</button>
                <h4><i class="icon fa fa-ban"></i><span id="session-token-alert-title"></span></h4>
                <div id="session-token-alert-errormessage-details" style="margin-left: 25px;">
                </div>
              </div>
          </div>

        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
</section>
<!-- /.content -->


<script type="text/javascript">
  var users = [];
  var sessions = [];

  $(document).ready(function () {
    fetchUsers();
    fetchSessions();
  });

  function copyToken() {
    var copyText = document.getElementById("token-body");
    copyText.select();
    document.execCommand("Copy");
    snackbar("Copied token to clipboard.");
  }

  function endSessionAlertDismiss() {
    $("#session-token-alert").addClass("hidden");
  }
  
  function endSessionAlertShow(error) {
    $("#session-token-alert-title").html(error.Message);

    if (error.Details.length > 0) {
      $("#session-token-alert-errormessage-details").append("<ul>");
      error.Details.map((detail) => {
        $("#session-token-alert-errormessage-details").append("<li> " + detail + "</li>");
      });

      $("#session-token-alert-errormessage-details").append("</ul>");
    }


    $("#session-token-alert").removeClass("hidden");
    shake('session-modal');
  }

  function endSession() {
    var token = $("#session-token").val();
   
     $.ajax({
      url: "api/v1/security/sessions/" + token,
      type: "DELETE",
      statusCode: {
        204: () => {
          $('#session-modal').modal('hide');
          snackbar("Session ended successfully");
          fetchSessions();
        },
        404: () => { endSessionAlertShow({ Message: "Session not found" }) },
        500: (xhr) => { endSessionAlertShow(xhr.responseJSON); }
      }
    });
  }

  function fetchUsers() {
    $("#users tbody:not(:first)").empty();
    $.get("api/v1/security/users").done(function (data) {
      users = data;

      users.forEach((element) => {
        var row = $("<tr>");

        row.append($("<td>" + element.Name + "</td>"))
          .append($("<td>" + element.DisplayName + "</td>"))
          .append($("<td>" + element.Email + "</td>"))
          .append($("<td>" + element.Role + "</td>"))
          .append($("<td><i class='fa fa-pencil' aria-hidden='true'/></i></td>"))
          .append($("<td><i class='fa fa-trash' aria-hidden='true'/></i></td>"));

        $("#users tbody").append(row);
      })
    })
  }

  function showToken(user, token) {
    $("#token-user").html(user);
    $("#token-body").val(token);
    $("#token-modal").modal();
  }

  function showEndSession(user, token) {
    $("#session-token-partial").html(token.substring(0, 15));
    $("#session-token").val(token);
    $("#session-user").html(user);
    $("#session-modal").modal();
  }

  function fetchSessions() {
    $("#sessions tbody:not(:first)").empty();

    $.get("api/v1/security/sessions").done(function (data) {
      sessions = data;

      sessions.forEach((element) => {
        var created = new Date(parseInt(element.Created.substr(6))).toTimeString().split(' ')[0];
        var expires = new Date(parseInt(element.Expires.substr(6))).toTimeString().split(' ')[0];
        var row = $("<tr>");

        row
          .append($("<td>" + element.Token.substring(0, 25) +
            "... <a href=\"javascript:showToken('" + element.User.Name + "','" + element.Token +
            "');\"><i class='fa fa-info-circle' aria-hidden='true'/></a></td>"))
          .append($("<td>" + element.User.Name + "</td>"))
          .append($("<td>" + created + "</td>"))
          .append($("<td>" + expires + "</td>"))
          .append($("<td><a href=\"javascript:showEndSession('" + element.User.Name + "','" + element.Token +
            "')\"><i class='fa fa-trash' aria-hidden='true'/></i></a></td></tr>"));

        $("#sessions tbody").append(row);
      })
    })
  }

  function shake(id) {
      var div = document.getElementById(id);
      var interval = 25;
      var distance = 10;
      var times = 3;

      //$(div).css('position', 'relative');

      for (var iter = 0; iter < (times + 1); iter++) {
        $(div).animate({
          left: ((iter % 2 == 0 ? distance : distance * -1))
        }, interval);
      }
      $(div).animate({
        left: 0
      }, interval);
    }
</script>