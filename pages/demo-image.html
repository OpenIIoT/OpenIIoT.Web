<section class="content-header">
    <h1>
        Demo - Image
        <small>Optional description</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Level</a></li>
        <li class="active">Here</li>
    </ol>
</section>

<section class="content container-fluid">
    
    <div id="info" class="info-box bg-default">
        <span class="info-box-icon"><i class="ion ion-ios-pricetag-outline"></i></span>

        <div class="info-box-content">
            <span id="fqn" class="info-box-number" style="font-size: 24px">OpenIIoT.Simulation.Binary.DynamicImage</span>
            <span id="timestamp" class="info-box-number" style="font-weight: 400; font-size: 16px"></span>
            <span id="quality" class="info-box-number" style="font-weight: 400; font-size: 16px"></span>
        </div>
    </div>

    <div class="row">
    <div class="col-md-6">
        <button type="button" class="btn btn-block btn-primary" id="subscribe" onclick="subscribe()">Subscribe</button>
    </div>
    <div class="col-md-6">
        <button type="button" class="btn btn-block btn-default" id="unsubscribe" onclick="unsubscribe()">Unsubscribe</button>
    </div>
    </div>
    
    <br/>

    <div class="box box-primary">
        <div class="box-header with-border">
            <i class="fa fa-image"></i>
            <h3 class="box-title">Image</h3>
        </div>
        <div class="box-body text-center">
            <img id="image" src="">
        </div>
    </div>
</section>

<script type="text/javascript">
    var chat;
    $(document).ready(function () {
        console.log('trying to connect to service');
        chat = HubProxyFactory('signalr', 'ItemHub');
        console.log('connected to service');

        $("#requestfqn").val("OpenIIoT.Simulation.Binary.DynamicImage");
    });


    function subscribe(fqn) {
        chat.invoke('subscribe', $("#fqn").text())
    }

    function unsubscribe(fqn) {
        chat.invoke('unsubscribe', $("#fqn").text())
    }

    function write(fqn, value) {
        chat.invoke('write', [$("fqn"), $("#value").val()]);
    }

    function HubProxyFactory(serverUrl, hubName) {
        console.log("creating hub proxy");

        var connection = $.hubConnection(serverUrl);
        var proxy = connection.createHubProxy(hubName);

        proxy.on('read', function (fqn, item) {
            var src = 'data:image/gif;base64,' + JSON.parse(item)

            console.log(src);
            $("#image").attr("src", src);

            var fqnobj = JSON.parse(fqn);
            $("#timestamp").text("Timestamp: " + fqnobj.Timestamp);
            $("#quality").text("Quality: " + fqnobj.Quality);
        });

		proxy.on('subscribeSuccess', function(fqn) {
            $("#info").removeClass("bg-aqua").removeClass("bg-red").addClass("bg-green");
        })
        
        proxy.on('unsubscribeSuccess', function(fqn) {
            $("#info").removeClass("bg-aqua").removeClass("bg-green").addClass("bg-aqua");
		})

        connection.start().done(function () {
            console.log("signalr started");
            subscribe();
        });

        console.log("proxy created");
        return proxy;
    }
</script>